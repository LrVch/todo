'use strict';

// here for template cash
angular.module('templates', []);
angular.module('templates').run(['$templateCache', function($templateCache) {$templateCache.put('templates/addsection.template.html','<a ng-class="{\'add-more show\': showAddButton, \'add-more\': !showAddButton,}" href="#" class ng-click="addMore($event)">see more</a>');
$templateCache.put('templates/images.template.html','<div class="row">\r\n    <div class="item col-xs-6 col-sm-4 col-md-2" ng-repeat="image in images">\r\n        <a href="#" class="item__link" ng-click="showPopup($event, $index)">\r\n            <div style=" background-image: url(\'{{ image.img.M.href }}\')" class="item__img"></div>\r\n            <p class="item__author">\r\n                {{ image.authors[0].name }}\r\n                <br>\r\n                {{ image.title }}\r\n            </p>\r\n        </a>\r\n    </div>\r\n</div>');
$templateCache.put('templates/popup.template.html','<div class="popup">\r\n    <div class="popup__inner">\r\n        <div class="popup__content">\r\n            <div class="popup__img" style="background-image: url(\'{{ img }}\')"></div>\r\n            <!--<img class="popup__img" ng-src="{{ img }}" imageonload="showImage"-->\r\n                 <!--isImageLoaded>-->\r\n\r\n            <a class="popup__next" href="#" ng-click="showNext($event)">\r\n                <span>next</span></a>\r\n            <a class="popup__prev" href="#" ng-click="showPrev($event)">\r\n                <span>prev</span></a>\r\n            <a class="popup__close" href="#" ng-click="hidePopup($event)"></a>\r\n            <p class="popup__capture">\r\n                {{ autor }}\r\n                <br>\r\n                {{ title }}\r\n            </p>\r\n        </div>\r\n    </div>\r\n    <div class="popup__overlay" ng-click="hidePopup($event)"></div>\r\n    <div class="popup__preloader" ></div>\r\n</div>');}]);
'use strict';

angular.module('galleryApp', ['core', 'cfp.hotkeys', 'templates']);
'use strict';

angular.module('galleryApp')
    .config(['$sceDelegateProvider', function ($sceDelegateProvider) {
        $sceDelegateProvider.resourceUrlWhitelist([
            'self',
            'http://api-fotki.yandex.ru/api/recent/?format=json']);
    }]);

"use strict";

angular.module('galleryApp')
    .controller('galleryController', ['$scope', 'Photo', function ($scope, Photo) {

        $scope.activeIndex = 0;
        $scope.showAddButton = false;

        $scope.popupState = {
            images: [],
            show: false,
            index: 0,
            showFn: function () {
                // console.log("this.show", this.show);
                // console.log("this.index", this.index);
            }
        };

        self.photo = Photo.get({}, function (photos) {
            $scope.photos = modifyData(photos.entries);
            $scope.initArray = $scope.photos[0];
            $scope.showAddButton = true;

            console.log($scope.photos)

            addImagesToPopupView($scope.initArray);
        });

        
        $scope.$watch('activeIndex', function (newval, oldval) {
            if (newval) {
                addImagesToPopupView($scope.photos[newval]);
            }
        });


        $scope.showPop = function () {
            $scope.popupState.show = true;
        };

        function addImagesToPopupView(arr) {
            $scope.popupState.images = $scope.popupState.images.concat(arr);
        }

        function modifyData(arr) {
            const result = [];
            const items = 18;
            const iterations = parseInt(arr.length / 18 + 1);

            for (var i = 0; i < iterations; i++) {
                result.push(arr.slice(i*items, (i + 1)*items));
            }

            return result;
        }
    }]);
'use strict';

// Define the `core` module
angular.module('core', ['core.photo']);

'use strict';

// Define the `core.phone` module
angular.module('core.photo', ['ngResource']);
'use strict';

angular.
  module('core.photo').
  factory('Photo', ['$resource',
    function($resource) {
      return $resource('https://cors-anywhere.herokuapp.com/http://api-fotki.yandex.ru/api/recent/?format=json', {});
      // return $resource('http://api-fotki.yandex.ru/api/recent/?format=json', {});
    }
  ]);

"use strict";

angular.module('galleryApp')
    .directive('images', function () {
        return {
            restrict: 'E',
            scope: {
                images: '=',
                index: "=",
                state: "="
            },
            templateUrl: 'templates/images.template.html',
            link: function (scope, element, attrs) {

                scope.showPopup = function showPopup($event, index) {
                    $event.preventDefault();

                    // console.log(scope.index);
                    // console.log(scope.index + index);

                    scope.state.show = true;
                    scope.state.index = scope.index + index;
                    scope.state.showFn();
                };
            }
        }
    });
"use strict";

angular.module('galleryApp')
    .directive('addSection', function ($compile) {
        return {
            restrict: 'E',
            templateUrl: 'templates/addsection.template.html',
            controller: function ($scope, $element) {
                var count = 0;

                $scope.addMore = function ($event) {
                    $event.preventDefault();

                    ++$scope.activeIndex;

                    count = $scope.activeIndex;

                    if (!$scope.photos[count + 1]) {
                        // return;
                        $scope.showAddButton = false;
                    }

                    var el = $compile("<images images='photos[" + count + "]' index='" + count * 18 + "' state='popupState'></images>")($scope);
                    var parent = $element.parent()[0].querySelector(".additional-sections");
                    var angParent = angular.element(parent);

                    angParent.append(el);
                };
            }
        }
    });
"use strict";


angular.module('galleryApp')
    .directive('popup', ['hotkeys', function (hotkeys) {
        return {
            restrict: 'E',
            scope: {
                state: "="
            },
            templateUrl: 'templates/popup.template.html',
            link: function (scope, element, attrs) {

                scope.preloader = false;

                hotkeys.add({
                    combo: 'left',
                    description: 'This one goes to left',
                    callback: function() {
                        scope.showPrev();
                    }
                });

                hotkeys.add({
                    combo: 'right',
                    description: 'This one goes to right',
                    callback: function() {
                        scope.showNext();
                    }
                });


                function loadingImg(url) {
                    return new Promise(function (resolve, reject) {
                        var img = document.createElement("img");
                        img.src = url;

                        if (img.complete && img.naturalWidth !== 0) {
                            return;
                        }

                        scope.showPreloader();
                        img.onload = function () {
                            resolve();
                        };

                        img.error = function () {
                            reject();
                        };
                    });
                }

                scope.$watch('state.show', function (newval, oldval) {
                    if (newval) {
                        scope.imageIndex = scope.state.index;
                        element.addClass('show');
                        scope.img = scope.state.images[scope.state.index].img.XXL.href;
                        scope.autor = scope.state.images[scope.state.index].authors[0].name;
                        scope.title = scope.state.images[scope.state.index].title;

                        loadingImg(scope.state.images[scope.state.index].img.XXL.href)
                            .then(function (resolve) {
                                // console.log(scope);
                                scope.hidePreloader();
                            });
                        

                        if (scope.state.index === 0) {
                            element[0].querySelector(".popup__prev").classList.add("hide");
                        }

                        if (scope.state.index === scope.state.images.length - 1) {
                            element[0].querySelector(".popup__next").classList.add("hide");
                        }
                    } else {
                        element.removeClass('show');
                        scope.img = "#";
                    }
                });


                scope.hidePopup = function ($event) {
                    $event.preventDefault();
                    scope.state.show = false;
                    scope.state.showFn();
                    element[0].querySelector(".popup__next").classList.remove("hide");
                    element[0].querySelector(".popup__prev").classList.remove("hide");
                };

                scope.showNext = function ($event) {
                    if ($event) {
                        $event.preventDefault();
                    }

                    const images = scope.state.images;
                    element[0].querySelector(".popup__prev").classList.remove("hide");

                    if (scope.imageIndex > images.length - 3) {
                        element[0].querySelector(".popup__next").classList.add("hide");
                    }

                    if (scope.imageIndex > images.length - 2) {
                        // console.log(element[0]);
                        return;
                    }

                    scope.imageIndex++;

                    scope.img = images[scope.imageIndex].img.XXL.href;
                    scope.autor = images[scope.imageIndex].authors[0].name;
                    scope.title = images[scope.imageIndex].title;

                    loadingImg(images[scope.imageIndex].img.XXL.href)
                        .then(function (resolve) {
                            // console.log(scope);
                            scope.hidePreloader();
                        });
                };

                scope.showPrev = function ($event) {
                    if ($event) {
                        $event.preventDefault();
                    }

                    const images = scope.state.images;
                    element[0].querySelector(".popup__next").classList.remove("hide");


                    if (scope.imageIndex < 2) {
                        element[0].querySelector(".popup__prev").classList.add("hide");
                    }

                    if (scope.imageIndex < 1) {
                        return;
                    }

                    scope.imageIndex--;

                    scope.img = images[scope.imageIndex].img.XXL.href;
                    scope.autor = images[scope.imageIndex].authors[0].name;
                    scope.title = images[scope.imageIndex].title;

                    loadingImg(images[scope.imageIndex].img.XXL.href)
                        .then(function (resolve) {
                            console.log(scope);
                            scope.hidePreloader();
                        });
                };

                scope.showPreloader = function () {
                    element.addClass('preloader');
                };

                scope.hidePreloader = function () {
                    element.removeClass('preloader');
                };
            }
        }
    }]);